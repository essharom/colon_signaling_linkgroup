---
title: "Esophagus cancer analysis after removal of arrays with poor quality"
output:
  html_document:
    df_print: paged
---

```{r, echo = FALSE, results='hide', message =FALSE}
memory.limit(9999999999)

library(kableExtra)
library(heatmaply)
library(knitr)
library(purrr)
library(dplyr)

load("B:/OneDrive/Data analysis/01_Data/02_Normalized data/02_Esophagus/DataInfo_Corrected.RData")

```

# Data summary

Table below summarizes GEO projects used in the analysis:


```{r, echo = FALSE, resutls = "asis", message =FALSE}


kable(bind_rows(DataInfo)[,-6], 
      caption = "Information about included projects") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(1, bold = T) # 
```

To further characterize the data use we look at the number of samples belonging to each project, using specific platform and representing a different phenotype:

```{r, echo = FALSE, resutls = "asis", message =FALSE}
source("ShapeData.R")

kable(PhenoSummary(PhenoData_QC), 
      caption = "Number of samples per project, platform and phenotpye") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(dim(PhenoSummary(PhenoData_QC))[1], bold = T) %>% # format last row
  column_spec(1, bold = T) #

```

# Data preprocessing

## Quality analysis

CEL. files belonging to relevant projects were read in using ReadAffy function and array quality was assessed before further processing.


```{r, echo = FALSE, resutls = "hide", message =FALSE}
library(lemon)

load("B:/OneDrive/Data analysis/01_Data/02_Normalized data/02_Esophagus/NormData_Corrected.RData")
load("B:/OneDrive/Data analysis/01_Data/02_Normalized data/02_Esophagus/GeneExpression_Corrected.RData")

# Box plots
source("Visualize.R")
par(mfrow=c(1,3))
BP_RMA_BG = BoxPlot(RMA_BG_QC,
                    Logaritmic = "y",
                    Title="RMA background correction")
BP_RMA =BoxPlot(RMA_QC, 
                    Logaritmic = "y", 
                    Title="RMA normalization")
BP_fRMA =  BoxPlot(fRMA_QC, 
                    Logaritmic = "y", 
                    Title="fRMA normalization")

### PCA plots
RMA_BG_GeneDF_QC = na.omit(List2DF(RMA_BG_GeneExp_QC))
RMA_GeneDF_QC = na.omit(List2DF(RMA_GeneExp_QC))
fRMA_GeneDF_QC = na.omit(List2DF(fRMA_GeneExp_QC))

PhenoData_QC = PhenoData_QC[which(rownames(PhenoData_QC) %in% colnames(RMA_GeneDF_QC)),]
fRMAPheno_QC = PhenoData_QC[which(rownames(PhenoData_QC) %in% colnames(fRMA_GeneDF_QC)),]

PCA_RMA_BG = PCAPlot(RMA_BG_GeneDF_QC,
                     PhenoData_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") + 
             ggtitle("RMA background correction")
PCA_RMA = PCAPlot(RMA_GeneDF_QC,
                     PhenoData_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") +
          ggtitle("RMA normalization")
PCA_fRMA = PCAPlot(fRMA_GeneDF_QC, 
                     PhenoData_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") + 
           ggtitle("fRMA normalization")
grid_arrange_shared_legend(PCA_RMA_BG, PCA_RMA, PCA_fRMA, ncol=3, nrow = 1)

heatmaply(data.frame(t(RMA_BG_GeneDF_QC) %*% as.matrix(RMA_BG_GeneDF_QC)),
                      col_side_colors = PhenoData_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "RMA background correction")
heatmaply(data.frame(t(RMA_GeneDF_QC) %*% as.matrix(RMA_GeneDF_QC)),
                      col_side_colors = PhenoData_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "RMA normalization")
heatmaply(data.frame(t(fRMA_GeneDF_QC) %*% as.matrix(fRMA_GeneDF_QC)),
                      col_side_colors = fRMAPheno_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "fRMA background correction")

```

## Batch removal


```{r, echo = FALSE, message = FALSE, warning= FALSE}
library(YuGene)

load("B:/OneDrive/Data analysis/01_Data/02_Normalized data/02_Esophagus/BatchCorData_Corrected.RData")

PCA_RMA_QN = PCAPlot(RMA_QN_QC,
                     PhenoData_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") + 
             ggtitle("RMA normalization & quantile normalization")
PCA_RMA_ComBat = PCAPlot(RMA_Combat_QC, 
                     PhenoData_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") +
                 ggtitle("RMA normalization & ComBat batch correction")
PCA_RMA_SVA = PCAPlot(RMA_SVA_QC, 
                     PhenoData_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") +
                 ggtitle("RMA normalization & SVA batch correction")
PCA_RMA_YuGene = autoplot(pca(t(RMA_YuGene_QC)),
                     data = PhenoData_QC, 
                     colour = "Phenotype", 
                     shape = "GEOStudyID") +
                 ggtitle("RMA normalization & YuGene batch correction")
grid_arrange_shared_legend(PCA_RMA_QN,
                           PCA_RMA_ComBat, 
                           PCA_RMA_SVA,
                           PCA_RMA_YuGene,
                           ncol=2,
                           nrow = 2)

PCA_fRMA_QN = PCAPlot(fRMA_QN_QC, 
                     fRMAPheno_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") +
              ggtitle("fRMA normalization & quantile normalization")
PCA_fRMA_ComBat = PCAPlot(fRMA_Combat_QC, 
                     fRMAPheno_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") +
                  ggtitle("fRMA normalization & ComBat batch correction")
PCA_fRMA_SVA = PCAPlot(fRMA_SVA_QC, 
                     fRMAPheno_QC,
                     colorCol = "Phenotype",
                     shapeCol = "GEOStudyID") +
                  ggtitle("fRMA normalization & SVA batch correction")
PCA_fRMA_YuGene = autoplot(pca(t(fRMA_YuGene_QC)),
                     data = fRMAPheno_QC, 
                     colour = "Phenotype", 
                     shape = "GEOStudyID") + 
                  ggtitle("fRMA normalization & YuGene batch correction")
grid_arrange_shared_legend(PCA_fRMA, 
                           PCA_fRMA_QN, 
                           PCA_fRMA_ComBat, 
                           PCA_fRMA_YuGene,
                           ncol=2,
                           nrow = 2)

heatmaply(data.frame(t(RMA_QN_QC) %*% as.matrix(RMA_QN_QC)),
                      col_side_colors = PhenoData_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "RMA normalization & quantile normalization")
heatmaply(data.frame(t(RMA_Combat_QC) %*% as.matrix(RMA_Combat_QC)),
                      col_side_colors = PhenoData_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "RMA normalization & ComBat batch correction")
heatmaply(data.frame(t(RMA_SVA_QC) %*% as.matrix(RMA_SVA_QC)),
                      col_side_colors = PhenoData_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "RMA normalization & SVA batch correction")
heatmaply(data.frame(t(RMA_Combat_QC) %*% as.matrix(RMA_Combat_QC)),
                      col_side_colors = PhenoData_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "RMA normalization & YuGene batch correction")

heatmaply(data.frame(t(fRMA_QN_QC) %*% as.matrix(fRMA_QN_QC)),
                      col_side_colors = fRMAPheno_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "fRMA normalization & quantile normalization")
heatmaply(data.frame(t(fRMA_Combat_QC) %*% as.matrix(fRMA_Combat_QC)),
                      col_side_colors = fRMAPheno_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "fRMA normalization & ComBat batch correction")
heatmaply(data.frame(t(fRMA_SVA_QC) %*% as.matrix(fRMA_SVA_QC)),
                      col_side_colors = fRMAPheno_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "fRMA normalization & SVA batch correction")
heatmaply(data.frame(t(fRMA_YuGene_QC) %*% as.matrix(fRMA_YuGene_QC)),
                      col_side_colors = fRMAPheno_QC[,c("GEOStudyID", "Phenotype")],
                      seriate = "mean", 
                      row_dend_left = TRUE,
                      plot_method = "plotly",
                      main = "fRMA normalization & YuGene batch correction")
```

